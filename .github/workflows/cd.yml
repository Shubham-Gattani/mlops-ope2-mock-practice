name: CI-CD to GCP Artifact Registry

permissions:
  contents: write
  id-token: write  # ADDED: Required for Google Cloud authentication

on:
  push:
    branches:
      - main

env:
  REGION: ${{ secrets.GCP_REGION }}
  REPO_NAME: mlops-ope2-mock-practice
  IMAGE_NAME: fraud-api

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Determine image URI
      id: image_uri  # ADDED: Need to capture output for later steps
      run: |
        IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${GITHUB_SHA:0:7}"
        LATEST_URI="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest"
        echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_OUTPUT
        echo "LATEST_URI=${LATEST_URI}" >> $GITHUB_OUTPUT
        echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV  # For backward compatibility

    - name: Build Docker image
      run: |
        docker build -t ${{ steps.image_uri.outputs.IMAGE_URI }} -t ${{ steps.image_uri.outputs.LATEST_URI }} .

    - name: Push Docker image
      run: |
        docker push ${{ steps.image_uri.outputs.IMAGE_URI }}
        docker push ${{ steps.image_uri.outputs.LATEST_URI }}

    # -----------------------
    # CML REPORT
    # -----------------------
    - name: Setup CML
      uses: iterative/setup-cml@v2
    
    - name: CML Report
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "### CI/CD Build Status" > report.md
        echo "- Docker build & push to Artifact Registry: SUCCESS" >> report.md
        echo "- Image (versioned): ${{ steps.image_uri.outputs.IMAGE_URI }}" >> report.md
        echo "- Image (latest): ${{ steps.image_uri.outputs.LATEST_URI }}" >> report.md
        echo "- Commit: ${GITHUB_SHA}" >> report.md
        cml comment create report.md

    # -----------------------
    # ðŸš€ Deploy to GKE
    # -----------------------
    - name: Get GKE Credentials
      uses: google-github-actions/get-gke-credentials@v1
      with:
        cluster_name: mlops-fraud-gke
        location: us-central1-a  # Make sure this matches your cluster location
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Update GKE Deployment With New Image
      run: |
        kubectl set image deployment/fraud-api fraud-api=${{ steps.image_uri.outputs.IMAGE_URI }}
        kubectl rollout status deployment/fraud-api --timeout=10m
